name: ğŸ”’ Pre-commit Security Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security-check:
    name: ğŸ” Detect Secrets & Security Issues
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified --fail

      - name: ğŸ” Check for hardcoded credentials
        run: |
          echo "ğŸ” Scanning for potential secrets..."

          # PadrÃµes perigosos
          if grep -rE "(sk-[a-zA-Z0-9]{48}|eyJ[a-zA-Z0-9_-]{30,})" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=dist; then
            echo "âŒ API keys encontradas no cÃ³digo!"
            exit 1
          fi

          # Check .env files
          if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E '\.env$'; then
            echo "âŒ Arquivo .env sendo commitado!"
            exit 1
          fi

          echo "âœ… No secrets detected"

      - name: ğŸ“‹ Verify .env.example exists
        run: |
          if [ ! -f "advo-ai-hub-main (1)/advo-ai-hub-main/.env.example" ]; then
            echo "âš ï¸ .env.example nÃ£o encontrado"
          else
            echo "âœ… .env.example existe"
          fi

      - name: ğŸ“ Check commit messages
        run: |
          echo "ğŸ“ Verificando mensagens de commit..."
          git log --format=%B -n 1 ${{ github.event.pull_request.head.sha }} | \
            grep -iE "(fix|feat|chore|docs|refactor|test|perf)" || \
            echo "âš ï¸ Considere usar conventional commits (fix:, feat:, etc.)"
